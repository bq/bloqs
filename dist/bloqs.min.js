/*! bloqs 15-04-2015 */
"use strict";function getRandomColor(){for(var a="0123456789ABCDEF".split(""),b="#",c=0;6>c;c++)b+=a[Math.floor(16*Math.random())];return b}function Bloq(a,b,c){this.canvas=c.canvas,this.bloqBody=this.canvas.group().move(b[0],b[1]),this.bloqData=a,this.bloqName=this.bloqData.label,this.data=c,this.size={width:100,height:50},this.delta={x:0,y:0,lastx:0,lasty:0},this.bloqInput={width:70,height:50},this.code=this.bloqData.code,this.relations={parent:void 0,children:[],codeChildren:[],inputChildren:[]},this.childrenNumber=0,this.createConnectors(),this.body=this.bloqBody.rect(this.size.width,this.size.height).fill(a.color).radius(4),this.id=this.body.node.id,this.size={width:this.bloqBody.bbox().width,height:this.bloqBody.bbox().height},this.childrenHeight=this.size.height,this.bloqData.hasOwnProperty("text")&&this.createBloqUI(),this.bloqBody.dragmove=Bloq.prototype.dragmove,this.bloqBody.dragend=Bloq.prototype.dragend;var d=this;this.bloqBody.getBloqObject=function(){return d},void 0!==this.bloqData.getVariable&&document.getElementById(this.data.element).addEventListener("change",function(){var a=document.getElementById(d.dropdownInput).childNodes,b=0;for(var c in d.data.variables)a[0][b].text=d.data.variables[c].label,b++},!1)}function OutputBloq(a,b,c){Bloq.call(this,a,b,c),this.bloqBody.draggable();var d="m 36,32 c -4.418,0 -8,-2.582 -8,-7 0,-4.418 3.582,-7 8,-7 l 0,14 z";this.bloqBody.connector=this.bloqBody.path(d).fill("#cccccc"),this.bloqBody.connector.x(-8),this.bloqBody.add(this.bloqBody.connector)}function StatementInputBloq(a,b,c,d){Bloq.call(this,a,b,c),d&&this.bloqBody.draggable(),this.statementInputCode="",this.updateConnector(this.connections.down[0],{x:20,y:0}),this.relations.codeStatementChildren={},this.bloqBody.downPart=this.bloqBody.rect(this.size.width,20).fill("#00CC00").radius(4),this.bloqBody.downPart.y(60),this.bloqBody.add(this.bloqBody.downPart),this.bloqBody.leftPart=this.bloqBody.rect(20,80).fill("#00CC00").radius(4),this.bloqBody.leftPart.size.height=80,this.bloqBody.leftPart.size.width=20,this.bloqBody.add(this.bloqBody.leftPart),this.size={width:this.bloqBody.bbox().width,height:this.bloqBody.bbox().height},this.childrenHeight=this.size.height,this.label=a.label,a.statementInput&&this.addDownConnector(this.bloqBody.x(),this.bloqBody.leftPart.size.height+this.bloqBody.y())}function ProjectBloq(a,b,c){Bloq.call(this,a,b,c,!1),this.bloqBody.text(a.label.toUpperCase()).font({family:"Helvetica",fill:"#fff",size:14}).move(20,5)}var utils=utils||{};utils.triggerGlobalOnChange=function(){$("field1").trigger("change")};var connectionThreshold=10;utils.oppositeConnection={inputs:"output",output:"inputs",up:"down",down:"up"},utils.getVariableType={text:"String",number:"int"},utils.manageConnections=function(a,b,c,d,e,f){if(void 0!==c&&void 0!==b&&utils.itsOver(b.connectorArea,c.connectorArea)){if(b.type===c.type||"all"===b.type||"all"===c.type)return console.log("CONNECT!",c.type,b.type),"inputs"===a||"down"===a?(d.updateBloqs(d,e,utils.oppositeConnection[a],f,c.type),e.moveTo(d.getConnectionPosition(a,e,f)),b.bloq=e,"all"===b.type&&d.setConnectionType(b,c),utils.bloqOnTop(e)):(d.updateBloqs(e,d,a,f,b.type),d.moveTo(e.getConnectionPosition(utils.oppositeConnection[a],d,f)),c.bloq=d,"all"===c.type&&e.setConnectionType(c,b),utils.bloqOnTop(d)),d.resetLastDelta(),!0;utils.rejectBloq(d),d.resetLastDelta()}return!1},utils.itsOver=function(a,b){return void 0!==a&&void 0!==b?a.x1<b.x2&&a.x2>b.x1&&a.y1<b.y2&&a.y2>b.y1:!1},utils.rejectBloq=function(a){var b={x:50,y:0};a.move2({x:b.x,y:b.y})},utils.bloqOnTop=function(a){a.bloqBody.node.parentNode.appendChild(a.bloqBody.node);var b={};for(var c in a.relations.children)b=a.relations.children[c].bloq,utils.bloqOnTop(b)},utils.getOutputBloq=function(a,b,c,d){var e="m 36,32 c -4.418,0 -8,-2.582 -8,-7 0,-4.418 3.582,-7 8,-7 l 0,14 z",f=a.group(),g=a.path(e).fill("#cccccc");g.x(b),f.add(g);var h=a.rect(c,d).fill("#cccccc").radius(4).move(b+8,0);return f.add(h),f},utils.getBloqById=function(a,b){for(var c in b.bloqs){var d=b.bloqs[c];if(d.id===a)return d}return null},Bloq.prototype.addVariable=function(a,b,c){void 0!==this.bloqData.variable&&(this.data.variables[a]={label:b,name:b,type:c})},Bloq.prototype.dragmove=function(a){this.dragmoveFlag=!0;var b=this.getBloqObject();if(utils.bloqOnTop(b),void 0!==b.relations.parent){var c=utils.getBloqById(b.relations.parent,b.data);c.resizeUI(b),c.deleteChild(this.getBloqObject()),this.getBloqObject().deleteParent(!1)}b.updateDeltas(a),b.updateConnectors(b.delta),b.moveChildren({x:b.delta.x,y:b.delta.y})},Bloq.prototype.dragend=function(){var a=this.getBloqObject();a.childrenNumber=a.relations.children.length,this.dragmoveFlag&&(a.resetLastDelta(),a.searchNewConnections(),this.dragmoveFlag=!1)},Bloq.prototype.searchNewConnections=function(){var a;for(var b in this.connections){console.log("Searching connection in bloqs connection:++++++++++++++++++++++++++++++++++",b);for(var c in this.data.bloqs)if(!isNaN(parseInt(c,10))&&this.data.bloqs[c].id!==this.id)if("inputs"===b)for(var d in this.connections[b])a=utils.manageConnections(b,this.connections[b][d],this.data.bloqs[c].connections[utils.oppositeConnection[b]],this,this.data.bloqs[c],d);else if("output"===b)for(var e in this.data.bloqs[c].connections[utils.oppositeConnection[b]])a=utils.manageConnections(b,this.connections[b],this.data.bloqs[c].connections[utils.oppositeConnection[b]][e],this,this.data.bloqs[c],e);else if("down"===b)for(var f in this.connections[b])a=utils.manageConnections(b,this.connections[b][f],this.data.bloqs[c].connections[utils.oppositeConnection[b]],this,this.data.bloqs[c],f);else if("up"===b)for(var g in this.data.bloqs[c].connections[utils.oppositeConnection[b]])a=utils.manageConnections(b,this.connections[b],this.data.bloqs[c].connections[utils.oppositeConnection[b]][g],this,this.data.bloqs[c],g);console.log("-------------")}console.log("-----------------------------------------------------------------------")},Bloq.prototype.updateBloqs=function(a,b,c,d,e){a.setChildren(b.id,c,d,e),b.setParent(a.id)},Bloq.prototype.deleteParent=function(a){if(a!==!1){var b=utils.getBloqById(this.relations.parent,this.data);b.bloqBody.relations.children=[]}this.relations.parent=void 0},Bloq.prototype.deleteChild=function(a){var b=0;if(void 0!==this.relations.children[a.id]&&"output"===this.relations.children[a.id].connection)for(b in this.connections.inputs)if(void 0!==this.connections.inputs[b].bloq&&this.connections.inputs[b].bloq.id===a.id){this.connections.inputs[b].bloq=void 0;break}delete this.relations.children[a.id];for(b in this.relations.codeChildren)if(this.relations.codeChildren[b]===a.id){this.relations.codeChildren.splice(b,1),this.decreaseChildrenHeight(a);break}delete this.relations.inputChildren[a.id]},Bloq.prototype.setChildren=function(a,b,c,d){for(var e in this.relations.children)if(a===this.relations.children[e])return!1;this.relations.children[a]={bloq:utils.getBloqById(a,this.data),connection:b,inputID:c};for(e in this.relations.codeChildren)if(a===this.relations.codeChildren[e])return!1;return"up"===b&&0===parseInt(c,10)?(this.relations.codeChildren.push(a),this.increaseChildrenHeight(utils.getBloqById(a,this.data)),this.resizeParents("down",utils.getBloqById(a,this.data))):"up"===b&&1===parseInt(c,10)?utils.getBloqById(a,this.data).stopSearchingParent=!0:this.relations.inputChildren[a]={bloq:utils.getBloqById(a,this.data),id:c,type:d},!0},Bloq.prototype.setConnectionType=function(a,b){a.type=b.type},Bloq.prototype.increaseChildrenHeight=function(a){this.childrenHeight+=a.childrenHeight,void 0!==this.relations.parent&&utils.getBloqById(this.relations.parent,this.data).increaseChildrenHeight(a)},Bloq.prototype.decreaseChildrenHeight=function(a){this.childrenHeight-=a.childrenHeight,void 0!==this.relations.parent&&utils.getBloqById(this.relations.parent,this.data).decreaseChildrenHeight(a)},Bloq.prototype.setParent=function(a){return this.relations.parent=a,!0},Bloq.prototype.getCode=function(a){var b,c,d=this.code[a].slice(),e="",f="";for(var g in d){for(c in this.relations.inputChildren)b=this.relations.inputChildren[c].id,b=b.substr(b.indexOf("_")+1,b.length),e="{["+b+"]}",f="userInput"===this.relations.inputChildren[c].bloq||"dropdown"===this.relations.inputChildren[c].bloq?this.relations.inputChildren[c].code:this.relations.inputChildren[c].bloq.getCode(a),d[g]=d[g].replace(new RegExp(e,"g"),f);for(c=0;c<this.inputsNumber;c++)e="{["+c+"]}",d[g]=d[g].replace(new RegExp(e,"g")," ");for(c in this.relations.inputChildren)typeof this.relations.inputChildren[c].bloq==typeof{}&&(e="{connectionType}",f=utils.getVariableType[this.relations.inputChildren[c].type],console.log("this.relations.inputChildren[i].",this.relations.inputChildren[c]),console.log("search , replacement:",e,f),d[g]=d[g].replace(new RegExp(e,"g"),f))}return d.join("")},Bloq.prototype.getStatementInputCode=function(a,b,c){if(b.value+="   "+a.getCode(c),void 0!==a.relations.codeChildren&&a.relations.codeChildren.length>0){var d=utils.getBloqById(a.relations.codeChildren,a.data);console.log("dummy",d),a.getStatementInputCode(d,b,c)}},Bloq.prototype.resizeParents=function(a,b){var c=this;if(!c.stopSearchingParent)do{if(void 0!==c.resizeStatementsInput&&("up"===a?(console.log("RESIZING PARENTS:",a,b.childrenHeight),c.resizeStatementsInput({x:0,y:-b.childrenHeight})):(console.log("RESIZING PARENTS:",a,b.childrenHeight),c.resizeStatementsInput({x:0,y:b.childrenHeight}))),c=utils.getBloqById(c.relations.parent,b.data),null===c)break;if(c.stopSearchingParent)break}while(void 0!==c.relations&&void 0!==c.relations.parent)},Bloq.prototype.updateConnector=function(a,b){return a.connectionPosition.x+=b.x,a.connectionPosition.y+=b.y,a.connectorArea.x1+=b.x,a.connectorArea.x2+=b.x,a.connectorArea.y1+=b.y,a.connectorArea.y2+=b.y,void 0!==a.UI&&a.UI.move(a.UI.x()+b.x,a.UI.y()+b.y),a},Bloq.prototype.updateConnectors=function(a){for(var b in this.connections)if(this.connections[b]&&"inputs"===b)for(var c in this.connections[b])this.updateConnector(this.connections[b][c],a);else if(this.connections[b]&&"down"===b&&typeof this.connections[b]==typeof[])for(var d in this.connections[b])this.updateConnector(this.connections[b][d],a);else this.connections[b]&&this.updateConnector(this.connections[b],a)},Bloq.prototype.moveConnector=function(a,b){if(a=this.updateConnector(a,b),void 0!==a.bloq){var c=a.bloq;c.move2(b)}this.resize(b)},Bloq.prototype.getConnectionPosition=function(a,b,c){if("up"===a)return{x:this.connections[a].connectionPosition.x,y:this.connections[a].connectionPosition.y-b.size.height};if("output"===a)return{x:this.connections[a].connectionPosition.x-b.size.width,y:this.connections[a].connectionPosition.y-c*connectionThreshold};if("inputs"===a){for(var d in this.connections[a])if(this.connections[a][d].inline===!0&&d===c&&void 0===this.connections[a][d].bloq){var e={x:b.size.width,y:0};this.resize(e);for(var f in this.UIElements)if(this.UIElements[f].id===parseInt(c,10)){this.pushElements(this.UIElements[f],e);break}}return this.connections[a][c].connectionPosition}return"down"===a?this.connections[a][c].connectionPosition:void 0},Bloq.prototype.createConnectors=function(){if(this.connections={},this.bloqData.inputs){this.connections.inputs=[{}];for(var a in this.bloqData.inputs)a=parseInt(a,10),this.connections.inputs[a]={connectionPosition:{},connectorArea:{},type:""},this.connections.inputs[a].connectionPosition={x:this.bloqBody.x()+this.size.width,y:this.bloqBody.y()+a*connectionThreshold},this.connections.inputs[a].connectorArea={x1:this.bloqBody.x()+this.size.width-connectionThreshold,x2:this.bloqBody.x()+this.size.width+connectionThreshold,y1:this.bloqBody.y()+a*connectionThreshold,y2:this.bloqBody.y()+a*connectionThreshold+connectionThreshold},this.connections.inputs[a].type=this.bloqData.inputs[a],this.connections.inputs[a].movedDown=!1,this.resize({x:0,y:connectionThreshold}),this.connections.inputs[a].UI=this.canvas.group().rect(2*connectionThreshold,connectionThreshold).attr({fill:getRandomColor()}).move(this.bloqBody.x()+this.size.width-connectionThreshold,this.bloqBody.y()+a*connectionThreshold)}this.bloqData.output&&(this.connections.output={connectionPosition:{},connectorArea:{},type:this.bloqData.output},this.connections.output.connectionPosition={x:this.bloqBody.x(),y:this.bloqBody.y()},this.connections.output.connectorArea={x1:this.bloqBody.x()-connectionThreshold,x2:this.bloqBody.x()+connectionThreshold,y1:this.bloqBody.y(),y2:this.bloqBody.y()+connectionThreshold},this.connections.output.UI=this.canvas.group().rect(2*connectionThreshold,connectionThreshold).attr({fill:"#FFCC33"}).move(this.bloqBody.x()-connectionThreshold,this.bloqBody.y())),this.bloqData.up&&(this.connections.up={connectionPosition:{},connectorArea:{}},this.connections.up.connectionPosition={x:this.bloqBody.x(),y:this.bloqBody.y()},this.connections.up.connectorArea={x1:this.bloqBody.x(),x2:this.bloqBody.x()+connectionThreshold,y1:this.bloqBody.y()-connectionThreshold,y2:this.bloqBody.y()+connectionThreshold},this.connections.up.UI=this.canvas.group().rect(connectionThreshold,2*connectionThreshold).attr({fill:"#FF0000"}).move(this.bloqBody.x(),this.bloqBody.y()-connectionThreshold)),this.bloqData.down&&(this.connections.down=[{}],this.connections.down[0].connectionPosition={x:this.bloqBody.x(),y:this.bloqBody.y()+this.size.height},this.connections.down[0].connectorArea={x1:this.bloqBody.x(),x2:this.bloqBody.x()+connectionThreshold,y1:this.bloqBody.y()+this.size.height-connectionThreshold,y2:this.bloqBody.y()+this.size.height+connectionThreshold},this.connections.down[0].UI=this.canvas.group().rect(connectionThreshold,2*connectionThreshold).attr({fill:"#FF0000"}).move(this.bloqBody.x(),this.bloqBody.y()+this.size.height-connectionThreshold))},Bloq.prototype.addInput=function(a,b,c){var d=0;void 0!==this.connections.inputs?d=this.connections.inputs.length:this.connections.inputs=[{}],this.connections.inputs[d]={connectionPosition:{x:a,y:b},connectorArea:{x1:a-connectionThreshold,x2:a+connectionThreshold,y1:b,y2:b+connectionThreshold},type:c,inline:!0,movedDown:!1},void 0!==a&&void 0!==b&&(this.connections.inputs[d].UI=this.canvas.group().rect(2*connectionThreshold,connectionThreshold).attr({fill:getRandomColor()}).move(a-connectionThreshold,b)),this.inputsNumber=this.connections.inputs.length},Bloq.prototype.resize=function(a){this.size.width+=a.x,this.size.height+=a.y,this.childrenHeight+=a.y,void 0!==this.bloqBody.children?this.bloqBody.children()[0].size(this.size.width,this.size.height):this.bloqBody.size(this.size.width,this.size.height)},Bloq.prototype.resizeUI=function(a){if("output"===this.relations.children[a.id].connection){for(var b in this.connections.inputs)if(this.connections.inputs[b].inline===!0&&b===this.relations.children[a.id].inputID){void 0!==this.bloqData.variable&&this.setConnectionType(this.connections.inputs[b],{type:"all"});var c={x:-a.size.width,y:0};this.resize(c),c={x:-a.size.width,y:0};for(var d in this.UIElements)if(this.UIElements[d].id===parseInt(b,10)){this.pushElements(this.UIElements[d],c);break}}}else"up"===this.relations.children[a.id].connection&&0===parseInt(this.relations.children[a.id].inputID,10)&&(this.deleteChild(a),this.resizeParents("up",a))},Bloq.prototype.pushElements=function(a,b){var c=a.elementsToPush;for(var d in c){c[d].bloq.x(c[d].bloq.x()+b.x),c[d].bloq.y(c[d].bloq.y()+b.y);var e=c[d].connector;void 0!==e&&this.moveConnector(e,b)}},Bloq.prototype.appendUserInput=function(a,b,c,d,e){var f=this.bloqBody.foreignObject(100,100).attr({id:"fobj",color:"#FFCC33"});f.appendChild("input",{id:e,value:a,color:"#FFCC33"}).move(c,d),this.UIElements.push({element:f,elementsToPush:void 0});var g;g="text"===b?'"'+document.getElementById(e).value+'"':document.getElementById(e).value,this.relations.inputChildren[e]={id:e,bloq:"userInput",code:g},this.addInput(void 0,void 0,b),this.addVariable(e,document.getElementById(e).value),document.getElementById(e).addEventListener("mousedown",function(a){a.stopPropagation()},!1);var h=this;document.getElementById(e).addEventListener("change",function(){h.addVariable(e,document.getElementById(e).value),"text"===b?h.relations.inputChildren[e].code='"'+document.getElementById(e).value+'"':"number"===b&&isNaN(parseFloat(document.getElementById(e).value))?document.getElementById(e).value="":h.relations.inputChildren[e].code=document.getElementById(e).value},!1)},Bloq.prototype.setUserInput=function(a,b){document.getElementById(this.id+"_"+a).value=b},Bloq.prototype.appendDropdownInput=function(a,b,c,d,e){var f=this.bloqBody.foreignObject(100,100).attr({id:e,color:"#FFCC33"}),g=this.populateDropDownList(a);this.addInput(void 0,void 0,b),f.appendChild(g).move(c,d),this.UIElements.push({element:f,elementsToPush:void 0}),this.relations.inputChildren[e]={id:e,bloq:"userInput",code:g.value},this.dropdownInput=e;var h=this;g.onchange=function(){h.relations.inputChildren[e].code=g.value},document.getElementById(e).addEventListener("mousedown",function(a){a.stopPropagation()},!1)},Bloq.prototype.populateDropDownList=function(a){var b=document.createElement("select");for(var c in a){var d=new Option(a[c].label,a[c].value);b.appendChild(d)}return b},Bloq.prototype.appendBloqInput=function(a,b,c,d,e){var f=utils.getOutputBloq(this.bloqBody,c,this.bloqInput.width,this.bloqInput.height);this.addInput(this.bloqBody.x()+c,this.bloqBody.y()+d,b),this.bloqBody.add(f),this.UIElements.push({element:f,elementsToPush:void 0,id:e,connector:this.connections.inputs[this.connections.inputs.length-1]})},Bloq.prototype.createBloqUI=function(){var a=10,b=20+a,c=0,d=a,e=0;this.UIElements=[{}];var f=0,g=0;for(g in this.bloqData.text){for(f in this.bloqData.text[g])if(typeof this.bloqData.text[g][f]==typeof{})"userInput"===this.bloqData.text[g][f].input?(this.appendUserInput(this.bloqData.text[g][f].label,this.bloqData.text[g][f].type,b,d,this.id+"_"+e),e+=1,b+=110):"bloqInput"===this.bloqData.text[g][f].input?(this.appendBloqInput(this.bloqData.text[g][f].label,this.bloqData.text[g][f].type,b,d-a,e),e+=1,b+=110):"dropdown"===this.bloqData.text[g][f].input&&(this.appendDropdownInput(this.bloqData.text[g][f].data,this.bloqData.text[g][f].type,b,d,this.id+"_"+e),e+=1,b+=110);else{var h=this.bloqBody.text(this.bloqData.text[g][f]).font({family:"Helvetica",fill:"#000",size:14}).move(b,d);b+=5*this.bloqData.text[g][f].length+30,this.UIElements.push({element:h,elementsToPush:void 0})}b>c&&(c=b),b=a,d+=40}this.UIElements.shift();for(f in this.UIElements){this.UIElements[f].elementsToPush=[{}];for(g in this.UIElements)g>f&&this.UIElements[f].elementsToPush.push({bloq:this.UIElements[g].element,connector:this.UIElements[g].connector});this.UIElements[f].elementsToPush.shift()}this.resize({x:c-this.size.width,y:d-this.size.height})},Bloq.prototype.moveTo=function(a){var b={x:this.bloqBody.x(),y:this.bloqBody.y()};this.bloqBody.x(a.x),this.bloqBody.y(a.y);var c={x:0,y:0};c.x=this.bloqBody.x()-b.x,c.y=this.bloqBody.y()-b.y,this.updateConnectors(c),this.moveChildren(c)},Bloq.prototype.move2=function(a,b){this.bloqBody.x(this.bloqBody.x()+a.x),this.bloqBody.y(this.bloqBody.y()+a.y),this.updateConnectors(a),b&&this.moveChildren(a)},Bloq.prototype.moveChildren=function(a){for(var b in this.relations.children){var c=this.relations.children[b].bloq;c.move2(a),void 0!==c.relations&&void 0!==c.relations.children&&c.moveChildren(a)}},Bloq.prototype.updateDeltas=function(a){this.delta.x=a.x-this.delta.lastx,this.delta.y=a.y-this.delta.lasty,this.delta.lastx=a.x,this.delta.lasty=a.y},Bloq.prototype.resetLastDelta=function(){this.delta.lastx=0,this.delta.lasty=0},OutputBloq.prototype=Object.create(Bloq.prototype);var StatementBloq=function(a,b,c){Bloq.call(this,a,b,c),this.bloqBody.draggable(),this.bloqBody.dragmove=StatementBloq.prototype.dragmove};StatementBloq.prototype=Object.create(Bloq.prototype),StatementInputBloq.prototype=Object.create(Bloq.prototype),StatementInputBloq.prototype.resizeStatementsInput=function(a){this.bloqBody.leftPart.height(this.bloqBody.leftPart.size.height),this.bloqBody.downPart.move(0,this.bloqBody.downPart.y()+a.y);var b=this.bloqBody.downPart.y()-this.bloqBody.leftPart.y()+20;this.bloqBody.leftPart.height(b),this.size.height+=a.y,void 0!==this.connections.down&&void 0!==this.connections.down[1]&&this.moveConnector(this.connections.down[1],{x:0,y:a.y})},StatementInputBloq.prototype.moveConnector=function(a,b){if(a=this.updateConnector(a,b),void 0!==a.bloq){var c=a.bloq;c.move2(b,!0)}},StatementInputBloq.prototype.addDownConnector=function(a,b){var c=0;void 0!==this.connections.down?c=this.connections.down.length:this.connections.down=[{}],this.connections.down[c]={connectionPosition:{x:a,y:b},connectorArea:{x1:a,x2:a+connectionThreshold,y1:b-connectionThreshold,y2:b+connectionThreshold}},void 0!==a&&void 0!==b&&(this.connections.down[c].UI=this.canvas.group().rect(connectionThreshold,2*connectionThreshold).attr({fill:getRandomColor()}).move(a,b-connectionThreshold))},StatementInputBloq.prototype.setChildren=function(a,b,c){for(var d in this.relations.children)if(a===this.relations.children[d])return!1;this.relations.children[a]={bloq:utils.getBloqById(a,this.data),connection:b,inputID:c};for(d in this.relations.codeChildren)if(a===this.relations.codeChildren[d])return!1;return"up"===b&&0===parseInt(c,10)?(this.relations.codeStatementChildren=utils.getBloqById(a,this.data),this.increaseChildrenHeight(utils.getBloqById(a,this.data)),this.resizeParents("down",utils.getBloqById(a,this.data))):"up"===b&&1===parseInt(c,10)?(this.relations.codeChildren.push(a),utils.getBloqById(a,this.data).stopSearchingParent=!0):this.relations.inputChildren[a]={bloq:utils.getBloqById(a,this.data),id:c},!0},StatementInputBloq.prototype.isNotEmpty=function(a){return!StatementInputBloq.prototype.isEmpty(a)},StatementInputBloq.prototype.isEmpty=function(a){if(null===a)return!0;if(a.length>0)return!1;if(0===a.length)return!0;for(var b in a)if(hasOwnProperty.call(a,b))return!1;return!0},StatementInputBloq.prototype.deleteChild=function(a){var b=0;if(void 0!==this.relations.children[a.id]&&"output"===this.relations.children[a.id].connection)for(b in this.connections.inputs)if(void 0!==this.connections.inputs[b].bloq&&this.connections.inputs[b].bloq.id===a.id){this.connections.inputs[b].bloq=void 0;break}delete this.relations.children[a.id];for(b in this.relations.codeChildren)if(this.relations.codeChildren[b]===a.id){this.relations.codeChildren.splice(b,1),this.decreaseChildrenHeight(a);break}delete this.relations.inputChildren[a.id],console.log("this.isNotEmpty(this.relations.codeStatementChildren) ",this.isNotEmpty(this.relations.codeStatementChildren)),this.isNotEmpty(this.relations.codeStatementChildren)&&a.id===this.relations.codeStatementChildren.id&&(this.relations.codeStatementChildren={})},StatementInputBloq.prototype.getCode=function(a){var b,c=this.code[a].slice(),d="",e="";for(var f in c){for(var g in this.relations.inputChildren)b=this.relations.inputChildren[g].id,b=b.substr(b.indexOf("_")+1,b.length),d="{["+b+"]}",e="userInput"===this.relations.inputChildren[g].bloq||"dropdown"===this.relations.inputChildren[g].bloq?this.relations.inputChildren[g].code:this.relations.inputChildren[g].bloq.getCode(a),c[f]=c[f].replace(new RegExp(d,"g"),e);for(g=0;g<this.inputsNumber;g++)d="{["+g+"]}",c[f]=c[f].replace(new RegExp(d,"g")," ");d="{StatementInput}";var h={value:""},i=this.relations.codeStatementChildren;this.isNotEmpty(i)&&this.getStatementInputCode(i,h,a),e=h.value,c[f]=c[f].replace(new RegExp(d,"g"),e)}return c.join("")},StatementInputBloq.prototype.resize=function(a){this.size.width+=a.x,this.size.height+=a.y,this.childrenHeight+=a.y,void 0!==this.bloqBody.children?this.bloqBody.children()[0].size(this.body.width()+a.x,this.body.height()+a.y):this.bloqBody.size(this.body.width()+a.x,this.body.height()+a.y)},ProjectBloq.prototype=Object.create(Bloq.prototype);var getProjectBloqs=function(){var a={setup:{label:"setup",down:!0,color:"#000",code:{setup:"",loop:"void setup (){\n"}},loop:{label:"loop",down:!0,color:"#000",code:{setup:"",loop:"void loop (){\n"}}};return a},getBasicBloqs=function(a){var b={led:{label:"led",up:!0,down:!0,color:"#e2e2e2",text:[[{input:"dropdown",type:"text",data:[{label:"Encender",value:"HIGH"},{label:"Apagar",value:"LOW"}]},"el LED",{input:"dropdown",type:"text",data:[{label:"LED1",value:"LED1"},{label:"LED2",value:"LED2"}]}]],code:{setup:["digitalWrite({1},{0});\n"],loop:["digitalWrite({1},{0});\n"]}},readSensor:{label:"readSensor",output:"number",color:"#e2e2e2",text:[["Leer",{input:"dropdown",type:"text",data:[{label:"Sensor1",value:"Sensor1"},{label:"Sensor2",value:"Sensor2"}]}]],code:{setup:["digitalRead({0})"],loop:["digitalRead({0})"]}},buzzer:{label:"buzzer",up:!0,down:!0,color:"#e2e2e2",text:[["Sonar el buzzer",{input:"dropdown",type:"text",data:[{label:"Buzzer1",value:"Buzzer1"},{label:"Buzzer2",value:"Buzzer2"}]},"con la nota",{input:"dropdown",type:"text",data:[{label:"Do",value:"200"},{label:"Re",value:"300"}]},"durante",{input:"userInput",type:"number",label:"0"},"ms"]],code:{setup:["tone({0},{1},{2});","delay({2});\n"],loop:["tone({0},{1},{2});","delay({2});\n"]}},forLoop:{label:"forLoop",up:!0,down:!0,statementInput:!0,color:"#e2e2e2",text:[["Contar con",{input:"bloqInput",type:"number",label:"INPUT"},"desde",{input:"bloqInput",type:"number",label:"INPUT"},"hasta",{input:"bloqInput",type:"number",label:"INPUT"},{input:"dropdown",type:"text",data:[{label:"sumando",value:"++"},{label:"restando",value:"--"}]}]],code:{setup:["for({0};{1};{2}){\n","{StatementInput}","\n"],loop:["for({0}={1};{0}<{2};{0}{3}){\n","{StatementInput}","\n"]}},number:{label:"number",output:"number",color:"#e2e2e2",text:[[{input:"userInput",type:"number",label:"0"}]],code:{setup:["{0}"],loop:["{0}"]}},text:{label:"text",output:"text",color:"#e2e2e2",text:[[{input:"userInput",type:"text",label:""}]],code:{setup:["{0}"],loop:["{0}"]}},getVariable:{label:"getVariable",output:"number",color:"#e2e2e2",text:[["Var",{input:"dropdown",type:"text",data:a}]],code:{setup:["{0}"],loop:["{0}"]},getVariable:!0},newGlobalVar:{label:"newGlobalVar",up:"true",down:"true",color:"#e2e2e2",text:[[{input:"userInput",type:"variable",label:"varName"},"=",{input:"bloqInput",type:"all",label:"INPUT"}]],code:{setup:["{connectionType} {0} = {1};\n"],loop:["{connectionType} {0} = {1};\n"]},variable:"global"}};return b};!function(a,b){"function"==typeof define&&define.amd?define(["jquery"],a):"object"==typeof exports?module.exports=a(require("jquery")):a(b,b.$)}(function(a,b){var c={bloqs:[],element:"",canvas:null,code:{setup:"",loop:""},variables:[],globalVariables:[],localVariables:[],project:[]},d={},e={};c.createCanvas=function(a){b.isEmptyObject(e)&&(c.element=a,d=SVG(a).size("100%","100%"),e=d.group().attr("class","bloqs-canvas")),c.canvas=e},c.bloqsToCode=function(){return c.functionCode(c.bloqs.setup,"setup"),c.functionCode(c.bloqs.loop,"loop"),c.code.setup+c.code.loop},c.functionCode=function(a,b){a===c.bloqs.loop||a===c.bloqs.setup?c.code[b]=a.code.loop:c.code[b]+="   "+a.getCode(b),a.relations.codeChildren.length>0?c.functionCode(utils.getBloqById(a.relations.codeChildren,c),b):c.code[b]+="\n}\n"},c.createBloq=function(a,b){var d;return a.hasOwnProperty("statementInput")?d=new StatementInputBloq(a,b,c,!0):a.hasOwnProperty("output")?d=new OutputBloq(a,b,c):"loop"===a.label?(d=new ProjectBloq(a,b,c),c.bloqs.loop=d):"setup"===a.label?(d=new ProjectBloq(a,b,c),c.bloqs.setup=d):d=new StatementBloq(a,b,c),c.bloqs.push(d),d},c.getBloq=function(a,b){return c.createBloq(getBasicBloqs(c.variables)[a],b)},c.createProjectStructure=function(){var a=getProjectBloqs(),b=100;for(var d in a)c.bloqs.push(this.createBloq(a[d],[50,b],c)),b+=100},c.createMenu=function(){var a=getBasicBloqs(),b=20;for(var d in a)c.bloqs.push(this.createBloq(a[d],[50,b])),b+=100},c.saveProject=function(){c.saveChildBloqs(c.bloqs.loop),console.log("savingproject:",JSON.stringify(c.project)),c.project=[]},c.saveChildBloqs=function(a){var b=[];if(null!==a&&void 0!==a.relations&&(b=this.getBloqData(a),c.project.push(b),void 0!==a.relations.codeChildren)){var d=utils.getBloqById(a.relations.codeChildren[0],this);this.saveChildBloqs(d,c.project)}},c.getBloqData=function(a){var b=[];if(void 0!==a.relations.inputChildren)for(var c in a.relations.inputChildren)if("userInput"===a.relations.inputChildren[c].bloq&&b.push({userInput:a.relations.inputChildren[c].code}),"dropdown"===a.relations.inputChildren[c].bloq&&b.push({dropdown:a.relations.inputChildren[c].code}),void 0!==a.relations.inputChildren[c].bloq&&void 0!==a.relations.inputChildren[c].bloq.bloqName){var d=a.relations.inputChildren[c].bloq;void 0!==d.relations.inputChildren?(console.log("this.getBloqData(child)",this.getBloqData(d)),b.push(this.getBloqData(d))):b.push({bloq:a.relations.inputChildren[c].bloq.bloqName,location:[a.relations.inputChildren[c].bloq.bloqBody.x(),a.relations.inputChildren[c].bloq.bloqBody.y()]})}return{bloq:a.bloqName,inputs:b,location:[a.bloqBody.x(),a.bloqBody.y()]}},c.loadProject=function(a){console.log("project_JSON",a);var b;for(var c in a)void 0!==a[c].bloq&&"loop"!==a[c].bloq&&"setup"!==a[c].bloq&&(b=this.getBloq(a[c].bloq,a[c].location),this.loadChildBloqs(a[c],b))},c.loadChildBloqs=function(a,b){if(console.log("projectBloq",a),a.inputs.length>0)for(var c in a.inputs)void 0!==a.inputs[c]&&(void 0!==a.inputs[c].bloq&&(console.log("projectBloq.inputs[i].bloq",a.inputs[c].bloq),this.loadChildBloqs(a.inputs[c],this.getBloq(a.inputs[c].bloq,a.inputs[c].location))),void 0!==a.inputs[c].userInput&&b.setUserInput(c,a.inputs[c].userInput))};var f=function(){return c};a.Bloqs=f},window);