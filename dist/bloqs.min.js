/*! bloqs 2016-01-04 */
"use strict";!function(exports,_,bloqsUtils,bloqsLanguages){var utils=bloqsUtils,lang="es-ES",connectors={},IOConnectors={},bloqs={},availableConnectors=[],availableIOConnectors=[],$field=null,scrollTop=0,softwareArrays={voidFunctions:[],returnFunctions:[],softwareVars:[],classes:[],objects:[]},dragPreviousTopPosition,dragPreviousLeftPosition,dragBloqMousePositionX,dragBloqMousePositionY,fieldOffsetTop,fieldOffsetLeft=0,fieldOffsetTopSource=[],fieldOffsetTopForced=0,mouseDownBloq=null,draggingBloq=null,startPreMouseMove=null,preMouseMoveX,preMouseMoveY,setOptions=function(a){fieldOffsetTopSource=a.fieldOffsetTopSource||[],fieldOffsetLeft=a.fieldOffsetLeft||0,fieldOffsetTopForced=a.fieldOffsetTopForced||0},getFieldOffsetTop=function(a){var b=0;if(fieldOffsetTopForced)b=fieldOffsetTopForced;else for(var c,d=0;d<a.length;d++)c=document.getElementsByClassName(a[d]),c[0]&&(b+=c[0].clientHeight);return b},bloqMouseDown=function(a){"SELECT"!==a.target.tagName&&(a.stopPropagation(),mouseDownBloq=a.currentTarget,startPreMouseMove=!0,document.addEventListener("mousemove",bloqPreMouseMove),document.addEventListener("mouseup",bloqMouseUpBeforeMove))},bloqMouseUpBeforeMove=function(){mouseDownBloq=null,document.removeEventListener("mousemove",bloqPreMouseMove),document.removeEventListener("mouseup",bloqMouseUpBeforeMove)},bloqPreMouseMove=function(a){if(startPreMouseMove){preMouseMoveX=a.pageX,preMouseMoveY=a.pageY,startPreMouseMove=!1;var b=mouseDownBloq.getBoundingClientRect();dragBloqMousePositionX=a.pageX-b.left,dragBloqMousePositionY=a.pageY-b.top,fieldOffsetTop=getFieldOffsetTop(fieldOffsetTopSource),dragPreviousTopPosition=b.top,dragPreviousLeftPosition=b.left,scrollTop=$field[0].scrollTop}else{var c=a.pageX-preMouseMoveX,d=a.pageY-preMouseMoveY;(Math.abs(c)>=5||Math.abs(d)>=5)&&(document.removeEventListener("mousemove",bloqPreMouseMove),document.addEventListener("mousemove",bloqMouseMove))}},bloqMouseMove=function(a){var b=null;if(mouseDownBloq){switch(b=bloqs[mouseDownBloq.getAttribute("data-bloq-id")],b.isConnectable()||(b.doConnectable(),$field.append(b.$bloq)),document.removeEventListener("mouseup",bloqMouseUpBeforeMove),document.addEventListener("mouseup",bloqMouseUp),mouseDownBloq.className=mouseDownBloq.className.concat(" dragging"),b.bloqData.type){case"statement":case"statement-input":statementDragStart(b);break;case"output":outputDragStart(b);break;case"group":throw"Group cant be moved";default:throw"Not defined bloq dragstart!!"}mouseDownBloq=null,draggingBloq=b}b=b||draggingBloq;var c=moveBloq(b,a.clientX,a.clientY);switch(b.bloqData.type){case"statement":case"statement-input":utils.redrawTree(b,bloqs,connectors),c>10&&handleCollisions([b.connectors[0],utils.getLastBottomConnectorUuid(b.uuid,bloqs,connectors)],a);break;case"output":c>10&&handleIOCollisions(b,availableIOConnectors);break;default:throw"Not defined bloq drag!!"}},bloqMouseUp=function(){scrollTop=0;var a=$(".connector.available").first(),b=draggingBloq;if(a[0]){switch(b.bloqData.type){case"statement":case"statement-input":statementDragEnd(b,a);break;case"output":outputDragEnd(b,a);break;default:throw"Not defined bloq drag!!"}b.$bloq.closest(".bloq--group")[0]?(b.enable(),("statement"===b.bloqData.type||"statement-input"===b.bloqData.type)&&utils.executeFunctionOnConnectedStatementBloqs("enable",b,bloqs,connectors)):(b.disable(),("statement"===b.bloqData.type||"statement-input"===b.bloqData.type)&&utils.executeFunctionOnConnectedStatementBloqs("disable",b,bloqs,connectors))}else b.disable(),("statement"===b.bloqData.type||"statement-input"===b.bloqData.type)&&utils.executeFunctionOnConnectedStatementBloqs("disable",b,bloqs,connectors);availableConnectors=[],availableIOConnectors=[],$(".bloq").removeClass("dragging"),$(".connector.available").removeClass("available"),$(".bloq--dragging").removeClass("bloq--dragging"),$field.focus(),draggingBloq=null,dragPreviousTopPosition=0,dragPreviousLeftPosition=0,document.removeEventListener("mousemove",bloqMouseMove),document.removeEventListener("mouseup",bloqMouseUp)},statementDragStart=function(a){var b=connectors[a.connectors[0]].connectedTo;if(b){var c=bloqs[connectors[b].bloqUuid],d=utils.itsInsideAConnectorRoot(a,bloqs,connectors);connectors[b].connectedTo=null,connectors[a.connectors[0]].connectedTo=null,d&&("group"===c.bloqData.type&&c.$bloq.removeClass("with--content"),removeFromStatementInput(a),utils.redrawTree(c,bloqs,connectors))}availableConnectors=[];for(var e in connectors)"connector--empty"!==connectors[e].data.type&&utils.getBloqByConnectorUuid(e,bloqs,connectors).isConnectable()&&(utils.connectorIsInBranch(e,a.uuid,bloqs,connectors)||availableConnectors.push(e))},removeFromStatementInput=function(a){var b,c=[a.$bloq],d=connectors[a.connectors[1]].connectedTo,e=a.$bloq.outerHeight(!0);for(a.$bloq.removeClass("inside-bloq");d;)b=bloqs[connectors[d].bloqUuid],c.push(b.$bloq),b.$bloq.removeClass("inside-bloq"),b.$bloq[0].style.transform="translate(0px,"+e+"px)",e+=b.$bloq.outerHeight(!0),d=connectors[b.connectors[1]].connectedTo;utils.appendArrayInOneTime($field,c)},outputDragStart=function(a){var b=utils.getOutputConnector(a,IOConnectors);if(b.connectedTo){a.$bloq.removeClass("nested-bloq");var c=IOConnectors[b.connectedTo],d=bloqs[c.bloqUuid];c.connectedTo=null,b.connectedTo=null,d.bloqData.returnType&&"fromInput"===d.bloqData.returnType.type&&updateSoftVar(d),$field[0].appendChild(a.$bloq[0])}availableIOConnectors=[];for(var e in IOConnectors)"connector--input"===IOConnectors[e].data.type&&utils.getBloqByConnectorUuid(e,bloqs,IOConnectors).isConnectable()&&(IOConnectors[e].connectedTo||utils.sameConnectionType(a,utils.getBloqByConnectorUuid(e,bloqs,IOConnectors),IOConnectors[e].data.acceptType,bloqs,IOConnectors,softwareArrays)&&(utils.connectorIsInBranch(e,a.uuid,bloqs,IOConnectors)||availableIOConnectors.push(e)))},moveBloq=function(a,b,c){var d,e,f,g,h=a.$bloq[0].getBoundingClientRect(),i=Math.round(Math.sqrt(Math.pow(dragPreviousTopPosition-h.top,2)+Math.pow(dragPreviousLeftPosition-h.left,2)));return scrollTop!==$field[0].scrollTop&&(scrollTop=$field[0].scrollTop),d=b-fieldOffsetLeft,e=c-fieldOffsetTop+scrollTop,f=d-dragBloqMousePositionX,g=e-dragBloqMousePositionY,a.$bloq[0].style.transform="translate("+f+"px,"+g+"px)",i>10&&(dragPreviousTopPosition=h.top,dragPreviousLeftPosition=h.left),"statement-input"===a.bloqData.type&&utils.redrawTree(a,bloqs,connectors),i},statementDragEnd=function(a,b){var c=b.attr("data-connector-id"),d=$('[data-connector-id="'+c+'"]').attr("data-canconnectwith"),e=utils.itsARootConnector(connectors[c])||utils.itsInsideAConnectorRoot(utils.getBloqByConnectorUuid(c,bloqs,connectors),bloqs,connectors);setLogicalConnections(c,d),e?connectorRootDragEnd(a,b):placeNestedBloq(c,d)},connectorRootDragEnd=function(a,b){var c=b.attr("data-connector-id"),d=bloqs[connectors[c].bloqUuid];if(a.$bloq.addClass("inside-bloq"),a.$bloq.removeAttr("style"),utils.itsARootConnector(connectors[c])){var e=d.$bloq.find(".bloq--extension__content");e.first().append(a.$bloq),d.$bloq.addClass("with--content")}else d.$bloq.after(a.$bloq);for(var f,g=connectors[a.connectors[1]].connectedTo,h=[];g;)f=bloqs[connectors[g].bloqUuid],h.push(f.$bloq),f.$bloq.addClass("inside-bloq"),f.$bloq.removeAttr("style"),g=connectors[f.connectors[1]].connectedTo;a.$bloq.after(utils.jqueryObjectsArrayToHtmlToInsert(h)),utils.redrawTree(d,bloqs,connectors)},outputDragEnd=function(a,b){var c=b.attr("data-connector-id"),d=utils.getOutputConnector(a,IOConnectors).uuid;b.append(a.$bloq),a.$bloq.addClass("nested-bloq").removeAttr("style"),IOConnectors[c].connectedTo=d,IOConnectors[d].connectedTo=c;var e=utils.getBloqByConnectorUuid(c,bloqs,IOConnectors),f=utils.getBloqByConnectorUuid(d,bloqs,IOConnectors);e.bloqData.returnType&&"fromInput"===e.bloqData.returnType.type&&(f.bloqData.returnType.pointer||updateSoftVar(e))},handleCollisions=function(a){var b,c,d,e,f;availableConnectors.forEach(function(g){for(d=connectors[g].jqueryObject,b=0,c=!1;!c&&b<a.length;)e=connectors[a[b]].jqueryObject,connectors[a[b]].data.type===connectors[g].data.accept&&utils.itsOver(e,d,20)?c=!0:b++;f=utils.getBloqByConnectorUuid(g,bloqs,connectors),c?(d.addClass("available"),d.attr("data-canconnectwith",a[b]),"group"===f.bloqData.type&&f.$bloq.addClass("bloq--dragging")):("group"===f.bloqData.type&&f.$bloq.removeClass("bloq--dragging"),d.removeClass("available"),d.removeAttr("data-canconnectwith"))})},handleIOCollisions=function(a,b){var c,d=utils.getOutputConnector(a,IOConnectors);b.forEach(function(a){c=IOConnectors[a],utils.itsOver(d.jqueryObject,c.jqueryObject,0)&&utils.sameConnectionType(bloqs[d.bloqUuid],bloqs[c.bloqUuid],c.data.acceptType,bloqs,IOConnectors,softwareArrays)?c.jqueryObject.addClass("available"):c.jqueryObject.removeClass("available")})},setLogicalConnections=function(a,b){if(connectors[a].connectedTo){var c,d,e,f;switch(connectors[a].data.type){case"connector--bottom":c=connectors[a].connectedTo,d=utils.getLastBottomConnectorUuid(connectors[b].bloqUuid,bloqs,connectors),connectors[d].connectedTo=c,connectors[c].connectedTo=d;break;case"connector--top":e=connectors[a].connectedTo,f=utils.getFirstTopConnectorUuid(connectors[b].bloqUuid,bloqs,connectors),connectors[e].connectedTo=f,connectors[f].connectedTo=e;break;case"connector--root":c=connectors[a].connectedTo,d=utils.getLastBottomConnectorUuid(connectors[b].bloqUuid,bloqs,connectors),connectors[d].connectedTo=c,connectors[c].connectedTo=d;break;default:throw"connector on setLogicalConnections no handled "+connectors[a].data.type}}connectors[a].connectedTo=b,connectors[b].connectedTo=a},placeNestedBloq=function(a,b){var c=bloqs[connectors[a].bloqUuid];switch(c.bloqData.type){case"statement":case"statement-input":utils.redrawTree(utils.getBloqByConnectorUuid(b,bloqs,connectors),bloqs,connectors);break;case"output":break;default:throw"bloqtype not defined in nesting "+c.bloqData.type}},updateSoftVar=function(a,b,c,d){var e=a.bloqData.createDynamicContent;if(!e)throw"We are adding a softVar on a bloq that not defined the dynamic content";if(!softwareArrays[e])throw"dynamicContentType not defined "+a.bloqData.name;for(var f=!1,g=0;!f&&g<softwareArrays[e].length;)softwareArrays[e][g].bloqUuid===a.uuid&&(f=!0),g++;c=c||utils.getTypeFromBloq(a,bloqs,IOConnectors,softwareArrays),d="statement-input"===a.bloqData.type&&a.bloqData.arguments?d||utils.getArgsFromBloq(a,bloqs,IOConnectors):"";var h;f?(h=softwareArrays[e][g-1],h.name=b||h.name,h.type=c,h.args=d,h.name?$('option[data-var-id="'+h.id+'"]').attr({value:h.name}).html(h.name):removeSoftVar(a)):b&&(h={name:b,id:utils.generateUUID(),bloqUuid:a.uuid,type:c,args:d},softwareArrays[e].push(h),$('select[data-dropdowncontent="'+e+'"]').append($("<option>").attr({"data-var-id":h.id,value:h.name}).html(h.name))),updateSoftVarTypes(softwareArrays,e,bloqs,IOConnectors)},removeSoftVar=function(a){for(var b=a.bloqData.createDynamicContent,c=!1,d=0;!c&&d<softwareArrays[b].length;)softwareArrays[b][d].bloqUuid===a.uuid&&(c=!0),d++;if(c){var e=softwareArrays[b][d-1];softwareArrays[b].splice(d-1,1),$('option[data-var-id="'+e.id+'"]').remove()}updateSoftVarTypes(softwareArrays,b,bloqs,IOConnectors)},updateSoftVarTypes=function(a,b,c,d){for(var e,f=0;f<a[b].length;f++)e=a[b][f],e.type=utils.getTypeFromBloq(c[e.bloqUuid],c,d,a)},removeBloq=function(a,b){var c,d=bloqs[a];if(!d)throw"Cant delete this bloq: "+a;var e,f,g;switch(d.$bloq[0].removeEventListener("mousedown",bloqMouseDown),(mouseDownBloq&&mouseDownBloq.getAttribute("data-bloq-id")===a||draggingBloq&&draggingBloq.uuid)&&(document.removeEventListener("mouseup",bloqMouseUpBeforeMove),document.removeEventListener("mousemove",bloqPreMouseMove),document.removeEventListener("mousemove",bloqMouseMove),document.removeEventListener("mouseup",bloqMouseUp)),d.bloqData.type){case"statement-input":case"group":for(var h,i=connectors[d.connectors[2]].connectedTo;i;)h=utils.getBloqByConnectorUuid(i,bloqs,connectors),i=connectors[h.connectors[1]].connectedTo,removeBloq(h.uuid);case"statement":if(e=connectors[d.connectors[0]].connectedTo,f=connectors[d.connectors[1]].connectedTo,e&&f)connectors[e].connectedTo=f,connectors[f].connectedTo=e,b&&utils.redrawTree(utils.getBloqByConnectorUuid(e,bloqs,connectors),bloqs,connectors);else if(e){connectors[e].connectedTo=null;var j=bloqs[connectors[e].bloqUuid];"group"===j.bloqData.type&&j.$bloq.removeClass("with--content"),b&&utils.redrawTree(utils.getBloqByConnectorUuid(e,bloqs,connectors),bloqs,connectors)}else f&&(connectors[f].connectedTo=null);var k;for(c=0;c<d.IOConnectors.length;c++)k=d.IOConnectors[c],"connector--input"===IOConnectors[k].data.type&&IOConnectors[k].connectedTo&&removeBloq(IOConnectors[IOConnectors[k].connectedTo].bloqUuid);break;case"output":g=IOConnectors[d.IOConnectors[0]].connectedTo,g&&(IOConnectors[g].connectedTo=null);break;default:throw"we dont know how to delete: "+d.bloqData.type}d.$bloq.remove();var l;for(c=0;c<d.connectors.length;c++)delete connectors[d.connectors[c]];for(c=0;c<d.IOConnectors.length;c++)delete IOConnectors[d.IOConnectors[c]];if(d.bloqData.createDynamicContent)removeSoftVar(d);else for(l in softwareArrays)updateSoftVarTypes(softwareArrays,l,bloqs,IOConnectors);delete bloqs[a]},buildContent=function(a){for(var b,c=a.componentsArray,d=a.bloqData,e=0;e<d.content.length;e++)for(var f=0;f<d.content[e].length;f++)b=createBloqElement(a,d.content[e][f],c,softwareArrays),"DOWN"===d.content[e][f].position?(a.$contentContainerDown.addClass("with-content"),a.$contentContainerDown.append(b)):a.$contentContainer.append(b)},buildStatementConnector=function(a,b,c,d,e){var f=$("<div>").attr({"data-connector-id":a});return f.addClass("connector connector--offline "+b.type),e.append(f),connectors[a]=d,c.connectors.push(a),f},buildConnectors=function(a,b){for(var c,d,e,f,g=0;g<a.length;g++){switch(d="connector:"+utils.generateUUID(),e={uuid:d,data:a[g],bloqUuid:b.uuid,connectedTo:null},a[g].type){case"connector--top":f="statement-input"===b.bloqData.type?b.$bloq.children(".bloq--statement-input__header"):b.$bloq.children(".bloq--fixed"),c=buildStatementConnector(d,a[g],b,e,f);break;case"connector--bottom":f="statement-input"===b.bloqData.type?b.$bloq.find(".bloq--extension--end"):b.$bloq.children(".bloq--fixed"),c=buildStatementConnector(d,a[g],b,e,f);break;case"connector--root":f="statement-input"===b.bloqData.type?b.$bloq.children(".bloq--statement-input__header"):b.$bloq,c=buildStatementConnector(d,a[g],b,e,f);break;case"connector--input":c=$(b.$bloq.find('.bloqinput[data-connector-name="'+a[g].name+'"]')),c.attr({"data-connector-id":d}).addClass("connector "+a[g].type),e.contentId=c.attr("data-content-id"),IOConnectors[d]=e,b.IOConnectors.push(d);break;case"connector--output":c=$("<div>").attr({"data-connector-id":d}).addClass("connector connector--offline "+a[g].type),b.$bloq.append(c),e.returnType=b.bloqData.returnType,IOConnectors[d]=e,b.IOConnectors.push(d);break;case"connector--empty":c=$("<div>"),connectors[d]=e,b.connectors.push(d);break;default:throw"Connector not defined to build"}e.jqueryObject=c}},createBloqElement=function(a,b,c,d){var e,f,g,h,i=null;switch(b.alias){case"staticDropdown":i=$("<select>"),i.attr({name:"","data-content-id":b.id});var j=[];for(e=0;e<b.options.length;e++)f=$("<option>").attr({value:b.options[e].value,"data-i18n":b.options[e].label}).html(translateBloq(lang,b.options[e].label)),j.push(f);utils.appendArrayInOneTime(i,j),b.value&&i.val(b.value),i.change(function(){}),a.bloqData.returnType&&"fromDropdown"===a.bloqData.returnType.type&&i.change(function(){updateSoftVar(a)});break;case"dynamicDropdown":switch(i=$("<select>"),i.attr({name:"","data-content-id":b.id,"data-dropdowncontent":b.options,"data-value":b.value}),b.options){case"voidFunctions":case"returnFunctions":case"softwareVars":case"classes":case"objects":g=d[b.options],i.change(function(){if("output"===a.bloqData.type){var b=utils.getOutputConnector(a,IOConnectors);if(b.connectedTo){var c=IOConnectors[b.connectedTo],d=bloqs[c.bloqUuid];d.bloqData.returnType&&"fromInput"===d.bloqData.returnType.type&&updateSoftVar(d)}}});break;case"varComponents":g=[];for(h in c)c[h].length>=1&&(g=g.concat(c[h]));break;case"clocks":g=[],g=c.clocks;break;case"hts221":g=[],g=c.hts221;break;default:g=c[b.options]}if(!g)throw"Dropdowns not defined in array: "+b.options;if(utils.drawDropdownOptions(i,g),b.value){i.val(b.value);var k=g.find(function(a){return a.name===b.value});i[0].dataset.reference=k?k.uid:"",i[0].dataset.value=b.value,i.val(b.value)}i.change(function(a){i[0].dataset.value=a.currentTarget.value,i[0].dataset.reference=a.currentTarget.selectedOptions[0].dataset.reference});break;case"text":i=$("<span>").attr({"data-i18n":b.value}).html(translateBloq(lang,b.value));break;case"removableText":i=$("<span>").html(b.value),i.addClass("removabletext");break;case"numberInput":i=$("<input>").attr({type:"text","data-content-id":b.id,"data-placeholder-i18n":b.placeholder,placeholder:translateBloq(lang,b.placeholder)}).val(b.value),i.bind("input",function(){var a=utils.getCaretPosition(this),b=utils.validNumber($(this).val());$(this).val(b.value),utils.setCaretPosition(this,a-b.removedChar)}),i.on("keyup",function(a){$(a.currentTarget).autoGrowInput({minWidth:60,comfortZone:30})}),i.change(function(){});break;case"stringInput":i=$("<input>").attr({type:"text","data-content-id":b.id,"data-content-type":b.alias,"data-placeholder-i18n":b.placeholder,placeholder:translateBloq(lang,b.placeholder)}).val(b.value),i.on("keyup",function(a){$(a.currentTarget).autoGrowInput({minWidth:100,comfortZone:30})}),i.change(function(){i.val(utils.validString(i.val())),console.log("change String!")});break;case"charInput":i=$("<input>").attr({type:"text","data-content-id":b.id,"data-content-type":b.alias,"data-placeholder-i18n":b.placeholder,placeholder:translateBloq(lang,b.placeholder)}).val(b.value),i.on("keyup",function(a){$(a.currentTarget).autoGrowInput({minWidth:100,comfortZone:30})}),i.change(function(){i.val(utils.validChar(i.val())),console.log("change Char!")});break;case"codeInput":i=$("<input>").attr({type:"text","data-content-id":b.id,"data-content-type":b.alias,"data-placeholder-i18n":b.placeholder,placeholder:translateBloq(lang,b.placeholder)}).val(b.value),i.on("keyup",function(a){$(a.currentTarget).autoGrowInput({minWidth:100,comfortZone:30})}),i.change(function(){console.log("change SCinput!")});break;case"multilineCodeInput":i=$('<textarea class="msd-elastic: \n;" ng-model="bar" cols="40" rows="1"></textarea>').attr({"data-content-id":b.id,"data-content-type":b.alias,name:b.id,"data-placeholder-i18n":b.placeholder,placeholder:translateBloq(lang,b.placeholder)}).val(b.value),setTimeout(function(){$('[name="'+b.id+'"]').autogrow({onInitialize:!0})},0),i.change(function(){console.log("change multilineCode!")});break;case"multilineCommentInput":i=$('<textarea class="msd-elastic: \n;" ng-model="bar" cols="40" rows="1"></textarea>').attr({"data-content-id":b.id,"data-content-type":b.alias,name:b.id,"data-placeholder-i18n":b.placeholder,placeholder:translateBloq(lang,b.placeholder)}).val(b.value),setTimeout(function(){$('[name="'+b.id+'"]').autogrow({onInitialize:!0})},0),i.keyup(function(){bloqsUtils.delay(function(){i.val(utils.validComment(i.val()))},1e3)}),i.change(function(){i.val(utils.validComment(i.val())),console.log("change multilineComment!")});break;case"varInput":i=$("<input>").attr({type:"text","data-content-id":b.id,"data-placeholder-i18n":b.placeholder,placeholder:translateBloq(lang,b.placeholder)}).val(b.value),a.varInputs=[],a.varInputs.push(i),i.addClass("var--input"),i.on("keyup",function(a){$(a.currentTarget).autoGrowInput({minWidth:100,comfortZone:30})}),i.keyup(function(){bloqsUtils.delay(function(){var b=utils.validName(i.val(),d);i.val(b),b?updateSoftVar(a,b):removeSoftVar(a,b)},1e3)}),i.change(function(){console.log("change varInput!")});break;case"bloqInput":i=$("<div>").attr({"data-connector-name":b.name,"data-content-id":b.bloqInputId}),i.addClass("bloqinput");break;case"headerText":i=$("<h3>").html(b.value),i.addClass("headerText");break;case"descriptionText":i=$("<p>").html(b.value),i.addClass("descriptionText");break;default:throw"elementSchema not defined: "+b.alias}return i},translateBloqs=function(a){if(a!==lang){lang=a;var b,c,d;for(var e in bloqs){c=bloqs[e].$bloq.find("[data-placeholder-i18n]"),b=bloqs[e].$bloq.find("[data-i18n]");for(var f=0;f<c.length;f++)d=c[f].getAttribute("data-placeholder-i18n"),c[f].placeholder=translateBloq(lang,d);for(var g=0;g<b.length;g++)d=b[g].getAttribute("data-i18n"),b[g].innerHTML=translateBloq(lang,d)}}},destroyFreeBloqs=function(){var a,b;for(a in bloqs)if(b=bloqs[a],b.isConnectable())switch(b.bloqData.type){case"statement":case"statement-input":connectors[b.connectors[0]].connectedTo||removeBloq(a);break;case"output":IOConnectors[b.IOConnectors[0]].connectedTo||removeBloq(a);break;case"group":break;default:throw"its free? "+b.bloqData.type}},getFreeBloqs=function(){var a,b,c,d,e=[];for(var f in bloqs)if(a=bloqs[f],a.isConnectable())switch(a.bloqData.type){case"statement":case"statement-input":if(!connectors[a.connectors[0]].connectedTo){for(b=[a.getBloqsStructure()],d=connectors[a.connectors[1]].connectedTo;d;)c=utils.getBloqByConnectorUuid(d,bloqs,connectors),b.push(c.getBloqsStructure()),d=connectors[c.connectors[1]].connectedTo;e.push({position:a.$bloq.position(),bloqGroup:b})}break;case"output":IOConnectors[a.IOConnectors[0]].connectedTo||(b=[a.getBloqsStructure()],e.push({position:a.$bloq[0].getBoundingClientRect(),bloqGroup:b}));break;case"group":break;default:throw"its free? "+a.bloqData.type}return e},updateDropdowns=function(){var a;for(a in softwareArrays)updateDropdown(a)},updateDropdown=function(a){var b,c;$('select[data-dropdownContent="'+a+'"]').each(function(d,e){b=$(e),c=b.attr("data-value"),bloqsUtils.drawDropdownOptions(b,softwareArrays[a]),c&&b.val(c)})},translateBloq=function(a,b){return bloqsLanguages.texts[a][b]||bloqsLanguages.texts["en-GB"][b]||bloqsLanguages.texts["es-ES"][b]||b},Bloq=function Bloq(params){this.uuid="bloq:"+utils.generateUUID(),$field=params.$field||$field,this.bloqData=params.bloqData,this.componentsArray=params.componentsArray,this.connectors=[],this.IOConnectors=[];var enable=!1,connectable,that=this;switch(this.collapseGroupContent=function(){var a=that.$bloq.children(".field--content");a.toggleClass("field--collapsed"),that.connectable=!that.connectable,a.parent().toggleClass("collapsed--field")},this.enable=function(a){if(!enable){if(this.$bloq.removeClass("disabled"),this.bloqData.content&&this.bloqData.content[0])for(var b=0;b<this.bloqData.content[0].length;b++)if("bloqInput"===this.bloqData.content[0][b].alias)for(var c,d=0;d<this.IOConnectors.length;d++)c=this.IOConnectors[d],"connector--input"===IOConnectors[c].data.type&&IOConnectors[c].connectedTo&&utils.getBloqByConnectorUuid(IOConnectors[c].connectedTo,bloqs,IOConnectors).enable();if(enable=!0,this.connectors[2]&&!a)for(var e,f=connectors[this.connectors[2]].connectedTo;f;)e=utils.getBloqByConnectorUuid(f,bloqs,connectors),e.enable(),f=connectors[e.connectors[1]].connectedTo}},this.disable=function(a){if(this.$bloq.addClass("disabled"),enable){if(this.bloqData.content&&this.bloqData.content[0])for(var b=0;b<this.bloqData.content[0].length;b++)switch(this.bloqData.content[0][b].alias){case"bloqInput":for(var c,d=0;d<this.IOConnectors.length;d++)c=this.IOConnectors[d],"connector--input"===IOConnectors[c].data.type&&IOConnectors[c].connectedTo&&utils.getBloqByConnectorUuid(IOConnectors[c].connectedTo,bloqs,IOConnectors).disable()}if(enable=!1,this.connectors[2]&&!a)for(var e,f=connectors[this.connectors[2]].connectedTo;f;)e=utils.getBloqByConnectorUuid(f,bloqs,connectors),e.disable(),f=connectors[e.connectors[1]].connectedTo}},this.itsEnabled=function(){return enable},this.doConnectable=function(){if(!connectable){if(this.bloqData.content&&this.bloqData.content[0])for(var a=0;a<this.bloqData.content[0].length;a++)if("bloqInput"===this.bloqData.content[0][a].alias)for(var b,c=0;c<this.IOConnectors.length;c++)b=this.IOConnectors[c],"connector--input"===IOConnectors[b].data.type&&IOConnectors[b].connectedTo&&utils.getBloqByConnectorUuid(IOConnectors[b].connectedTo,bloqs,IOConnectors).doConnectable();if(this.connectors[2])for(var d,e=connectors[this.connectors[2]].connectedTo;e;)d=utils.getBloqByConnectorUuid(e,bloqs,connectors),d.doConnectable(),e=connectors[d.connectors[1]].connectedTo;connectable=!0,this.$bloq[0].dispatchEvent(new Event("bloq:connectable"))}},this.doNotConnectable=function(){connectable=!1},this.isConnectable=function(){return connectable},this.itsFree=function(){return 0===this.$bloq.closest(".bloq--group").length},this.$bloq=$("<div>").attr({"data-bloq-id":this.uuid,tabIndex:0}),this.$bloq.addClass("bloq bloq--"+this.bloqData.type+" "+this.bloqData.bloqClass),bloqs[this.uuid]=this,this.doNotConnectable(),this.bloqData.type){case"statement-input":this.$bloq.append('<div class="bloq--statement-input__header"></div><div class="bloq--extension"><div class="bloq--extension__content"></div> <div class="bloq--extension--end"></div></div>'),this.$contentContainer=this.$bloq.find(".bloq--statement-input__header"),this.$contentContainerDown=this.$bloq.find(".bloq--extension--end"),buildContent(this),this.$bloq[0].addEventListener("mousedown",bloqMouseDown),buildConnectors(params.bloqData.connectors,this),this.$contentContainer.children().children().not(".connector.connector--offline").first().addClass("bloq__inner--first"),this.$contentContainer.children().children().not(".connector.connector--offline").last().addClass("bloq__inner--last"),this.$contentContainer.children().not(".connector.connector--offline").last().addClass("bloq__inner--last"),this.$contentContainerDown.children().not(".connector.connector--offline").first().addClass("bloq__inner--first"),this.$contentContainerDown.children().not(".connector.connector--offline").last().addClass("bloq__inner--last");break;case"statement":this.$bloq.append('<div class="bloq--fixed">'),this.$contentContainer=this.$bloq.find(".bloq--fixed"),buildContent(this),this.$bloq[0].addEventListener("mousedown",bloqMouseDown),buildConnectors(params.bloqData.connectors,this),this.$bloq.children().children().not(".connector.connector--offline").first().addClass("bloq__inner--first"),this.$bloq.children().children().not(".connector.connector--offline").last().addClass("bloq__inner--last");break;case"output":this.$contentContainer=this.$bloq,buildContent(this),this.$bloq[0].addEventListener("mousedown",bloqMouseDown),buildConnectors(params.bloqData.connectors,this),this.$bloq.children().not(".connector.connector--offline").first().addClass("bloq__inner--first"),this.$bloq.children().not(".connector.connector--offline").last().addClass("bloq__inner--last");break;case"group":this.$bloq.append('<div class="field--header"><button class="btn btn--collapsefield"></button><h3 data-i18n="'+this.bloqData.headerText+'">'+translateBloq(lang,this.bloqData.headerText)+'</h3></div><div class="field--content"><p data-i18n="'+this.bloqData.descriptionText+'">'+translateBloq(lang,this.bloqData.descriptionText)+'</p><div class="bloq--extension--info" data-i18n="drag-bloq" > '+translateBloq(lang,"drag-bloq")+'</div><div class="bloq--extension__content"></div></div>'),buildConnectors(params.bloqData.connectors,this),this.$bloq.find(".connector--root").addClass("connector--root--group"),this.$bloq.find(".field--header .btn").on("click",this.collapseGroupContent),this.$bloq.find(".field--header h3").on("click",this.collapseGroupContent);break;default:throw"bloqData "+this.bloqData.type+"not defined in bloq construction"}if(this.bloqData.createDynamicContent){var name=utils.validName(this.$bloq.find("input.var--input").val());name?updateSoftVar(this,name):removeSoftVar(this,name)}return this.getIOConnectorUuidByContentId=function(a){for(var b=!1,c=0,d=null;!b&&c<this.IOConnectors.length;)IOConnectors[this.IOConnectors[c]].contentId===a&&(b=!0,d=this.IOConnectors[c]),c++;return d},this.getCode=function(previousCode){var code=this.bloqData.code,childBloq,childConnectorId,elementTags=_.without(_.pluck(this.bloqData.content[0],"id"),void 0),childrenTags=_.without(_.pluck(this.bloqData.content[0],"bloqInputId"),void 0),value="",type="",connectionType="";elementTags.forEach(function(a){var b=this.$contentContainer.find('> [data-content-id="'+a+'"]');0===b.length&&(b=this.$contentContainer.find('[data-content-id="'+a+'"]')),value=b.val()||"";for(var c=0;c<this.componentsArray.sensors.length;c++)value===this.componentsArray.sensors[c].name&&(type=this.componentsArray.sensors[c].type,value="analog"===type?"analogRead("+this.componentsArray.sensors[c].pin.s+")":"digital"===type?"digitalRead("+this.componentsArray.sensors[c].pin.s+")":"LineFollower"===type?"(float *)"+this.componentsArray.sensors[c].name+".read()":this.componentsArray.sensors[c].name+".read()",code=code.replace(new RegExp("{"+a+".type}","g"),value));"stringInput"===b.attr("data-content-type")?value=utils.validString(value):"charInput"===b.attr("data-content-type")?value=utils.validChar(value):"multilineCommentInput"===b.attr("data-content-type")&&(value=utils.validComment(value));var d=value.replace(" *","");code=code.replace(new RegExp("{"+a+"}.withoutAsterisk","g"),d),code=code.replace(new RegExp("{"+a+"}","g"),value)}.bind(this));var bloqInputConnectors=utils.getInputsConnectorsFromBloq(IOConnectors,bloqs,this);if(childrenTags.length>0)for(var k=0;k<bloqInputConnectors.length;k++){value="",connectionType="",type="";var a=IOConnectors[bloqInputConnectors[k]];a&&(childConnectorId=a.connectedTo,null!==childConnectorId&&(childBloq=utils.getBloqByConnectorUuid(childConnectorId,bloqs,IOConnectors),value=childBloq.getCode(),type=childBloq.bloqData.returnType),"fromDynamicDropdown"===type.type?connectionType=utils.getFromDynamicDropdownType(childBloq||this,type.idDropdown,type.options,softwareArrays,this.componentsArray):"fromDropdown"===type.type?connectionType=utils.getTypeFromBloq(childBloq||this,bloqs,IOConnectors,softwareArrays):(connectionType=type.value,"string"===connectionType&&(connectionType="String"))),void 0===connectionType&&(connectionType=""),code=code.replace(new RegExp("{"+childrenTags[k]+".connectionType}","g"),connectionType),code=code.replace(new RegExp("{"+childrenTags[k]+"}","g"),value)}var reg=/(.*)\?(.*):(.*)/g;reg.test(code)&&(code=eval(code));var children=[];if(this.connectors[2]){if(value="",childConnectorId=connectors[this.connectors[2]].connectedTo){childBloq=utils.getBloqByConnectorUuid(childConnectorId,bloqs,connectors);var branchConnectors=utils.getBranchsConnectorsNoChildren(childBloq.uuid,connectors,bloqs);branchConnectors.forEach(function(a){if(utils.itsInsideAConnectorRoot(bloqs[connectors[a].bloqUuid],bloqs,connectors)){var b=connectors[a].bloqUuid;b!==children[children.length-1]&&children.push(b)}})}children.forEach(function(a){value+=bloqs[a].getCode()}),code=code.replace(new RegExp("{STATEMENTS}","g"),value)}if(code.indexOf("{CLASS-OUTSIDE}")>=0){var rootParentName=utils.getClassName(this,bloqs,connectors);rootParentName&&(code=code.replace(new RegExp("{CLASS-OUTSIDE}","g"),rootParentName)),code=code.replace(new RegExp("{CLASS-OUTSIDE}","g"),"")}return void 0===previousCode?previousCode="":code=bloqsUtils.splice(code,code.indexOf("{")+1,0,previousCode),this.itsEnabled()||(code=""),code},this.getBloqsStructure=function(){var a,b={};b.name=this.bloqData.name,b.enable=this.itsEnabled();var c=this.connectors[2];if(c){b.childs=[];for(var d=connectors[c].connectedTo;d;)a=utils.getBloqByConnectorUuid(d,bloqs,connectors),b.childs.push(a.getBloqsStructure()),d=connectors[a.connectors[1]].connectedTo}b.content=[[]];var e,f,g,h;if(this.bloqData.content[0])for(var i=0;i<this.bloqData.content[0].length;i++){switch(e=null,this.bloqData.content[0][i].alias){case"varInput":case"stringInput":case"numberInput":case"multilineCodeInput":case"multilineCommentInput":
case"codeInput":case"charInput":f=this.$bloq.find('[data-content-id="'+this.bloqData.content[0][i].id+'"]').val(),f&&(e={alias:this.bloqData.content[0][i].alias,id:this.bloqData.content[0][i].id,value:f});break;case"bloqInput":var j,k;j=this.getIOConnectorUuidByContentId(this.bloqData.content[0][i].bloqInputId),"connector--input"===IOConnectors[j].data.type&&IOConnectors[j].connectedTo&&(k=utils.getBloqByConnectorUuid(IOConnectors[j].connectedTo,bloqs,IOConnectors),e={alias:this.bloqData.content[0][i].alias,bloqInputId:this.bloqData.content[0][i].bloqInputId,value:k.getBloqsStructure()});break;case"dynamicDropdown":h=this.$bloq.find('select[data-content-id="'+this.bloqData.content[0][i].id+'"][data-dropdowncontent="'+this.bloqData.content[0][i].options+'"]').attr("data-value"),g=this.$bloq.find('select[data-content-id="'+this.bloqData.content[0][i].id+'"][data-dropdowncontent="'+this.bloqData.content[0][i].options+'"]').val();var l=this.bloqData.content[0][i].options,m=Object.keys(softwareArrays).indexOf(l);f=-1!==m?g:h||g,f&&(e={alias:this.bloqData.content[0][i].alias,id:this.bloqData.content[0][i].id,value:f});break;case"staticDropdown":f=this.$contentContainer.find('> select[data-content-id="'+this.bloqData.content[0][i].id+'"]').val(),f&&(e={alias:this.bloqData.content[0][i].alias,id:this.bloqData.content[0][i].id,value:f});break;case"text":break;default:throw"I dont know how to get the structure from this contentType :( "+this.bloqData.content[0][i].alias}e&&b.content[0].push(e)}return b},this};return exports.Bloq=Bloq,exports.updateSoftVar=updateSoftVar,exports.connectors=connectors,exports.IOConnectors=IOConnectors,exports.bloqs=bloqs,exports.removeBloq=removeBloq,exports.translateBloqs=translateBloqs,exports.getFreeBloqs=getFreeBloqs,exports.destroyFreeBloqs=destroyFreeBloqs,exports.updateDropdowns=updateDropdowns,exports.setOptions=setOptions,exports}(window.bloqs=window.bloqs||{},_,bloqsUtils,bloqsLanguages,void 0);